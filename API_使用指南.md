# é¢„è­¦ç³»ç»Ÿ API ä½¿ç”¨æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªç”¨Goè¯­è¨€å¼€å‘çš„é¢„è­¦ä¿¡æ¯ç®¡ç†ç³»ç»ŸAPIï¼Œæ”¯æŒæ¥æ”¶é¢„è­¦ä¿¡æ¯ã€æŸ¥è¯¢ç»Ÿè®¡å’Œé‚®ä»¶é€šçŸ¥åŠŸèƒ½ã€‚

**æœåŠ¡åœ°å€**: `http://0.0.0.0:8080`
**APIç‰ˆæœ¬**: `v1`
**åŸºç¡€è·¯å¾„**: `/api/v1`

## ğŸ”§ æ¥å£åˆ—è¡¨

### 1. å¥åº·æ£€æŸ¥
æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ

**è¯·æ±‚**:
```bash
GET /health
```

### 2. é…ç½®æŸ¥çœ‹
æŸ¥çœ‹å½“å‰ç³»ç»Ÿé…ç½®ä¿¡æ¯

**è¯·æ±‚**:
```bash
GET /config
```

**å“åº”**:
```json
{
  "status": "ok",
  "email_config": {
    "api_url": "http://opi.kgidc.cn/mail/email/send_email.php",
    "app_id": "v1-5f4769fe10c9c",
    "app_secret": "***hidden***",
    "from": "system@company.com",
    "to": ["felixgao@kugou.net"],
    "debug_mode": false,
    "debug_api_url": "http://10.16.2.146:6709/mail/email/send_email.php"
  }
}
```

### 3. é‚®ä»¶æµ‹è¯•
æµ‹è¯•é‚®ä»¶å‘é€åŠŸèƒ½

**è¯·æ±‚**:
```bash
POST /test-email
```

**å“åº”**:
```json
{
  "code": 200,
  "message": "æµ‹è¯•é‚®ä»¶å‘é€æˆåŠŸ",
  "data": {
    "alert_count": 2,
    "recipients": ["felixgao@kugou.net"]
  }
}
```

### 4. åˆ›å»ºé¢„è­¦ä¿¡æ¯

**å“åº”**:
```json
{
  "status": "ok",
  "message": "æœåŠ¡æ­£å¸¸è¿è¡Œ"
}
```

### 5. åˆ›å»ºé¢„è­¦ä¿¡æ¯
å‘ç³»ç»Ÿæäº¤æ–°çš„é¢„è­¦ä¿¡æ¯

**è¯·æ±‚**:
```bash
POST /api/v1/alerts
Content-Type: application/json
```

**è¯·æ±‚ä½“**:
```json
{
  "domain": "search.suggest.kgidc.cn",
  "message": "åŒ—æ–¹å·²åˆ‡é‡,ä½†å—æ–¹è¶…è¿‡24å°æ—¶æœªåˆ‡é‡,è¯·æ£€æŸ¥",
  "source": "RPCåå°",
  "status": "active",
  "region": "å…¨å›½",
  "alert_time": "2025-01-15 10:30:00"
}
```

**å­—æ®µè¯´æ˜**:
- `domain` (å¿…å¡«): åŸŸå
- `message` (å¿…å¡«): é¢„è­¦ä¿¡æ¯å†…å®¹
- `source` (å¿…å¡«): é¢„è­¦æ¥æº
- `status` (å¯é€‰): é¢„è­¦çŠ¶æ€ï¼Œå¦‚ "active", "resolved", "warning"
- `region` (å¯é€‰): åŒºåŸŸä¿¡æ¯
- `alert_time` (å¯é€‰): é¢„è­¦æ—¶é—´ï¼Œæ ¼å¼ä¸º "YYYY-MM-DD HH:mm:ss"ï¼Œé»˜è®¤ä¸ºå½“å‰æ—¶é—´

**å“åº”**:
```json
{
  "code": 200,
  "message": "é¢„è­¦ä¿¡æ¯åˆ›å»ºæˆåŠŸ",
  "data": {
    "id": 1,
    "domain": "search.suggest.kgidc.cn",
    "message": "åŒ—æ–¹å·²åˆ‡é‡,ä½†å—æ–¹è¶…è¿‡24å°æ—¶æœªåˆ‡é‡,è¯·æ£€æŸ¥",
    "source": "RPCåå°",
    "status": "active",
    "region": "å…¨å›½",
    "alert_time": "2025-01-15T10:30:00Z",
    "created_at": "2025-01-15T10:30:00Z",
    "updated_at": "2025-01-15T10:30:00Z"
  }
}
```

### 6. è·å–æ‰€æœ‰é¢„è­¦ä¿¡æ¯
è·å–ç³»ç»Ÿä¸­çš„æ‰€æœ‰é¢„è­¦ä¿¡æ¯ï¼Œæ”¯æŒåˆ†é¡µ

**è¯·æ±‚**:
```bash
GET /api/v1/alerts?page=1&size=20
```

**æŸ¥è¯¢å‚æ•°**:
- `page` (å¯é€‰): é¡µç ï¼Œé»˜è®¤ä¸º1
- `size` (å¯é€‰): æ¯é¡µæ•°é‡ï¼Œé»˜è®¤ä¸º20ï¼Œæœ€å¤§100

**å“åº”**:
```json
{
  "code": 200,
  "message": "è·å–é¢„è­¦ä¿¡æ¯æˆåŠŸ",
  "data": [
    {
      "id": 1,
      "domain": "search.suggest.kgidc.cn",
      "message": "åŒ—æ–¹å·²åˆ‡é‡,ä½†å—æ–¹è¶…è¿‡24å°æ—¶æœªåˆ‡é‡,è¯·æ£€æŸ¥",
      "source": "RPCåå°",
      "status": "active",
      "region": "å…¨å›½",
      "alert_time": "2025-01-15T10:30:00Z",
      "created_at": "2025-01-15T10:30:00Z",
      "updated_at": "2025-01-15T10:30:00Z"
    }
  ],
  "total": 1,
  "page": 1,
  "size": 20
}
```

### 7. æŒ‰æ—¶é—´æ®µæŸ¥è¯¢é¢„è­¦
æ ¹æ®æ—¶é—´èŒƒå›´æŸ¥è¯¢é¢„è­¦ä¿¡æ¯

**è¯·æ±‚**:
```bash
GET /api/v1/alerts/period?start_time=2025-01-15 07:00:00&end_time=2025-01-15 22:00:00
```

**æŸ¥è¯¢å‚æ•°**:
- `start_time` (å¯é€‰): å¼€å§‹æ—¶é—´ï¼Œæ ¼å¼ä¸º "YYYY-MM-DD HH:mm:ss"
- `end_time` (å¯é€‰): ç»“æŸæ—¶é—´ï¼Œæ ¼å¼ä¸º "YYYY-MM-DD HH:mm:ss"

**æ³¨æ„**: å¦‚æœä¸æä¾›æ—¶é—´å‚æ•°ï¼Œé»˜è®¤æŸ¥è¯¢å½“å¤©æ™šä¸Š7ç‚¹åˆ°10ç‚¹çš„æ•°æ®

**å“åº”**:
```json
{
  "code": 200,
  "message": "è·å–é¢„è­¦ä¿¡æ¯æˆåŠŸ",
  "data": [
    {
      "id": 1,
      "domain": "search.suggest.kgidc.cn",
      "message": "åŒ—æ–¹å·²åˆ‡é‡,ä½†å—æ–¹è¶…è¿‡24å°æ—¶æœªåˆ‡é‡,è¯·æ£€æŸ¥",
      "source": "RPCåå°",
      "status": "active",
      "region": "å…¨å›½",
      "alert_time": "2025-01-15T10:30:00Z",
      "created_at": "2025-01-15T10:30:00Z",
      "updated_at": "2025-01-15T10:30:00Z"
    }
  ],
  "start_time": "2025-01-15 07:00:00",
  "end_time": "2025-01-15 22:00:00",
  "total": 1
}
```

## ğŸš€ è°ƒç”¨ç¤ºä¾‹

### cURL ç¤ºä¾‹

#### 1. åˆ›å»ºé¢„è­¦ä¿¡æ¯
```bash
curl -X POST http://localhost:8080/api/v1/alerts \
  -H "Content-Type: application/json" \
  -d '{
    "domain": "search.suggest.kgidc.cn",
    "message": "åŒ—æ–¹å·²åˆ‡é‡,ä½†å—æ–¹è¶…è¿‡24å°æ—¶æœªåˆ‡é‡,è¯·æ£€æŸ¥",
    "source": "RPCåå°",
    "status": "active",
    "region": "å…¨å›½"
  }'
```

#### 2. è·å–æ‰€æœ‰é¢„è­¦
```bash
curl http://localhost:8080/api/v1/alerts
```

#### 3. æŒ‰æ—¶é—´æ®µæŸ¥è¯¢
```bash
curl "http://localhost:8080/api/v1/alerts/period?start_time=2025-01-15%2007:00:00&end_time=2025-01-15%2022:00:00"
```



## ğŸ“§ é‚®ä»¶é€šçŸ¥

ç³»ç»Ÿä¼šåœ¨æ¯å¤©æ™šä¸Š10ç‚¹è‡ªåŠ¨ç»Ÿè®¡å½“å¤©æ™šä¸Š7ç‚¹åˆ°10ç‚¹çš„é¢„è­¦ä¿¡æ¯ï¼Œå¹¶å‘é€é‚®ä»¶é€šçŸ¥ã€‚

é‚®ä»¶å†…å®¹é‡‡ç”¨æ–°çš„é¢„è­¦é€šçŸ¥æ ·å¼ï¼ŒåŒ…å«ï¼š
- ç»Ÿè®¡æ‘˜è¦
- è¯¦ç»†çš„é¢„è­¦ä¿¡æ¯å¡ç‰‡
- æ¯ä¸ªé¢„è­¦åŒ…å«å›¾æ ‡ã€æ ‡é¢˜ã€è¯¦ç»†ä¿¡æ¯å’Œæ—¶é—´æˆ³

### é‚®ä»¶é…ç½®

ç³»ç»Ÿä½¿ç”¨HTTP APIæ–¹å¼å‘é€é‚®ä»¶ï¼Œéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ä»¥ä¸‹å‚æ•°ï¼š

```bash
# é‚®ä»¶é…ç½® - ä½¿ç”¨HTTP APIæ–¹å¼
EMAIL_API_URL=http://opi.kgidc.cn/mail/email/send_email.php
EMAIL_APP_ID=v1-5f4769fe10c9c
EMAIL_APP_SECRET=c1e271982a82e325ef8ab5b0313fd102
EMAIL_FROM=system@company.com
EMAIL_TO=felixgao@kugou.net
EMAIL_DEBUG_MODE=false
EMAIL_DEBUG_API_URL=http://10.16.2.146:6709/mail/email/send_email.php
```

**é…ç½®è¯´æ˜**ï¼š
- `EMAIL_API_URL`: é‚®ä»¶å‘é€APIåœ°å€ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- `EMAIL_APP_ID`: åº”ç”¨ID
- `EMAIL_APP_SECRET`: åº”ç”¨å¯†é’¥
- `EMAIL_FROM`: å‘ä»¶äººåœ°å€
- `EMAIL_TO`: æ”¶ä»¶äººåœ°å€ï¼Œå¤šä¸ªåœ°å€ç”¨é€—å·åˆ†éš”
- `EMAIL_DEBUG_MODE`: æ˜¯å¦å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼ˆtrue/falseï¼‰
- `EMAIL_DEBUG_API_URL`: è°ƒè¯•æ¨¡å¼ä¸‹çš„APIåœ°å€

### æµ‹è¯•é‚®ä»¶å‘é€

å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æµ‹è¯•é‚®ä»¶å‘é€åŠŸèƒ½ï¼š

```bash
# è¿è¡Œé‚®ä»¶æµ‹è¯•å·¥å…·
go run test_email.go
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ—¶é—´æ ¼å¼**: æ‰€æœ‰æ—¶é—´å‚æ•°å¿…é¡»ä½¿ç”¨ "YYYY-MM-DD HH:mm:ss" æ ¼å¼
2. **å¿…å¡«å­—æ®µ**: domainã€messageã€source ä¸ºå¿…å¡«å­—æ®µ
3. **åˆ†é¡µé™åˆ¶**: æ¯é¡µæœ€å¤§è¿”å›100æ¡è®°å½•
4. **æœåŠ¡çŠ¶æ€**: è°ƒç”¨å‰å»ºè®®å…ˆæ£€æŸ¥ `/health` æ¥å£ç¡®è®¤æœåŠ¡çŠ¶æ€
5. **é”™è¯¯å¤„ç†**: æ‰€æœ‰æ¥å£éƒ½ä¼šè¿”å›æ ‡å‡†çš„é”™è¯¯å“åº”æ ¼å¼

## ğŸ” é”™è¯¯å“åº”æ ¼å¼

```json
{
  "code": 400,
  "message": "é”™è¯¯æè¿°ä¿¡æ¯"
}
```

å¸¸è§é”™è¯¯ç ï¼š
- `400`: è¯·æ±‚å‚æ•°é”™è¯¯
- `500`: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

